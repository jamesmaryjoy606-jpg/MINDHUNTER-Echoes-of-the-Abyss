<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MINDHUNTER: Echoes of the Abyss</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Aldrich&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #000000;
            color: #d1d1d1;
        }
        .font-title { font-family: 'Aldrich', sans-serif; }
        .container-bg { background-color: #0a0a0a; }
        .border-line { border-color: #222; }
        .accent-red { color: #dc2626; }
        .accent-red-bg { background-color: #dc2626; }
        .accent-blue { color: #2563eb; }
        
        .text-glow { text-shadow: 0 0 8px rgba(220, 38, 38, 0.7); }
        .button {
            background-color: #1a1a1a;
            border: 1px solid #444;
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        .button:hover:not(:disabled) {
            background-color: #dc2626;
            color: #fff;
            border-color: #ff0000;
        }
        .button.disabled, .button:disabled {
            filter: grayscale(1) brightness(0.5);
            cursor: not-allowed;
        }
        .timer-critical {
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { color: #dc2626; text-shadow: 0 0 8px rgba(220, 38, 38, 0.7); }
            50% { color: #f87171; text-shadow: 0 0 12px rgba(220, 38, 38, 1); }
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            z-index: 1000;
        }
        .image-container {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: #111;
            border: 1px solid #333;
        }
        .loader {
            border: 4px solid #333;
            border-top: 4px solid #dc2626;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="p-2 md:p-4">

    <div class="max-w-7xl mx-auto">
        <!-- HEADER -->
        <header class="flex justify-between items-center p-4 border-b-2 border-line container-bg rounded-t-lg">
            <h1 class="text-xl md:text-3xl font-title accent-red text-glow">ECHOES OF THE ABYSS</h1>
            <div class="text-center">
                <div class="text-sm text-gray-400">TIME REMAINING</div>
                <div id="timer" class="text-2xl md:text-4xl font-bold">10:00</div>
            </div>
            <div id="level-display" class="text-lg md:text-xl font-bold">LEVEL 1</div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-4 mt-4">
            <!-- LEFT PANEL: VISUALS -->
            <div class="lg:col-span-3 container-bg p-4 md:p-6 rounded-lg border-line">
                <h2 id="case-title" class="text-2xl font-bold border-b-2 border-line pb-2 mb-4"></h2>
                <div id="visual-output" class="image-container flex items-center justify-center rounded-lg overflow-hidden">
                    <p class="text-gray-500">VISUAL ANALYSIS PENDING</p>
                </div>
            </div>

            <!-- RIGHT PANEL: NARRATIVE & ACTION -->
            <div class="lg:col-span-2 container-bg p-4 rounded-lg border-line flex flex-col">
                <div class="flex-grow">
                    <h3 class="font-bold text-lg mb-3">NARRATIVE ANALYSIS</h3>
                    <div id="narrative-text" class="text-md leading-relaxed mb-6 h-48 overflow-y-auto pr-2"></div>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-3">PROFILER ACTIONS</h3>
                    <div id="choices" class="grid grid-cols-1 gap-3"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL -->
    <div id="modal" class="modal-overlay flex justify-center items-center">
        <div class="container-bg border-2 border-red-700 rounded-lg p-8 text-center w-11/12 max-w-2xl shadow-2xl shadow-red-900/50">
            <h2 id="modal-title" class="text-4xl font-bold font-title accent-red text-glow mb-4">BRIEFING</h2>
            <div id="modal-content" class="text-xl mb-8 leading-relaxed">
                <p id="modal-text"></p>
            </div>
            <div id="modal-buttons">
                <button id="modal-button" class="button text-2xl font-bold py-3 px-12 rounded-lg">BEGIN ANALYSIS</button>
            </div>
        </div>
    </div>


<script>
const gameData = {
    levels: [
        {
            level: 1, title: "The Dollmaker", timer: 600,
            briefing: "A killer is posing his victims in macabre, lifelike tableaus inside their own homes. The scenes are immaculate, but the violence is extreme. He is organized, but deeply psychotic. Your task: find the pattern in his 'art' before his next exhibition. You have M.O. Analysis.",
            narrative: "Case 8-B. The victim, a local librarian, is seated at her dining table, a porcelain doll in her lap. The scene is disturbingly serene, except for the evidence of a brutal, violent struggle hidden just out of sight. This UNSUB is a paradox: rage and control in one package. What is the primary analytical focus?",
            imagePrompt: "Cinematic, hyperrealistic photo of a dimly lit dining room. A single woman sits at the table, unnaturally still like a doll. Shadows obscure the details of violence. Ominous, dread-filled atmosphere, high contrast.",
            psychProfilePrompt: "Generate a psychological profile for a serial killer known as 'The Dollmaker'. M.O.: Breaks into the homes of victims who live alone, brutally murders them, then stages their bodies in serene, doll-like tableaus. He is highly organized and leaves the scenes immaculate, but there is evidence of extreme, repressed rage. Key psychological insight: He is obsessively trying to build a 'perfect family' to replace one he lost, seeing his victims as surrogates.",
            choices: [
                { text: "Analyze the M.O. The staging is the key.", next: '1_mo', imagePrompt: "Forensic photo, close-up on a victim's hand placed perfectly on a porcelain doll, dust motes in the air, cold lighting, hyper-detailed." },
                { text: "Analyze Victimology. Why her? Why like this?", next: '1_victimology', imagePrompt: "Split image. Left side: a smiling photo of the victim in life. Right side: the cold, pale face of the victim in death, posed like a doll. Stark contrast, emotionally brutal." },
            ]
        },
        {
            level: 2, title: "The St. Jude Serpent", timer: 540,
            briefing: "A new threat. Bodies are appearing in hospitals, the victims expiring from untraceable poisons. The killer leaves a single, scorched feather at each scene. He believes he is a righteous purifier. You've unlocked Victimology Insight. Unmask this angel of death.",
            narrative: "St. Jude's Hospital. Another victim. No signs of struggle, just a peaceful death that toxicology can't explain. The only clue is the small, burnt feather on the bedside table. This UNSUB is a 'power-assurance' killer, enjoying the god-like control over life and death.",
            imagePrompt: "Gritty, cinematic shot of a sterile hospital room at night. A body lies peacefully in bed. On the nightstand, a single, blackened feather smokes gently. Deep shadows, terrifyingly calm.",
            psychProfilePrompt: "Generate a psychological profile for a serial killer known as 'The St. Jude Serpent'. M.O.: Works in a hospital and administers untraceable poisons to patients, leaving a single scorched feather as a calling card. He is meticulous and leaves no other evidence. Key psychological insight: He is a 'Medical Killer' with a god complex, specifically targeting terminal patients who have secretly requested dark web euthanasia services, seeing himself as a merciful angel while truly being a predator who craves power over life and death.",
            choices: [
                { text: "Use Victimology Insight: These victims are not random. Find the link he sees.", next: '2_insight', requires: 'Victimology Insight', imagePrompt: "A digital screen showing three patient files. A glowing red line connects a hidden diagnosis they all share. Hacker-style interface, dark room, cinematic." },
                { text: "Focus on the feather. It's a symbolic message.", next: '2_symbol', imagePrompt: "Extreme close-up on a scorched feather, embers still glowing faintly. The barbs look like twisted snakeskin. Macabre and detailed." }
            ]
        },
        {
           level: 3, title: "The Red Tariff", timer: 480,
            briefing: "A killer is targeting high-profile executives, leaving them in their boardrooms. The scenes are clean, but the bodies are marked with a cryptic symbol painted in their own blood. He's operating in a world you don't have access to. You've unlocked Geographic Profiling. Find his comfort zone.",
            narrative: "CEO of Aerodyne Corp. found in his penthouse office. The scene is immaculate, security footage wiped. The only signature is a complex symbol, a bloody spiral, on the main window overlooking the city. This UNSUB is educated, patient, and invisible to the system. He moves without friction in the corporate world.",
            imagePrompt: "Cinematic, wide shot from behind a massive CEO desk. A body lies on the floor. On the panoramic window overlooking a sparkling city at night, a bloody spiral symbol drips slowly. High-tech, cold, and brutal.",
            psychProfilePrompt: "Generate a psychological profile for a serial killer known as 'The Red Tariff'. M.O.: Methodically hunts and kills high-profile corporate executives involved in a specific hostile takeover. He is patient, intelligent, and leaves a bloody spiral symbol at each scene. Key psychological insight: He is not a corporate insider, but the disgraced CEO of the company that was destroyed by his victims. He is a 'Mission-Oriented' killer, driven by revenge and a desire to reclaim his lost power and identity by systematically eliminating those who wronged him.",
            choices: [
                { text: "Use Geographic Profiling: Analyze the corporate locations. Find his operational base.", next: '3_geo', requires: 'Geographic Profiling', imagePrompt: "A holographic city map with glowing red skyscrapers. Lines of data converge on a single, unassuming office building in the financial district. Futuristic, Minority Report style." },
                { text: "Combine Abilities: Use Victimology to find a common business deal, then Geographic Profiling to link their offices.", next: '3_combo', requires: ['Victimology Insight', 'Geographic Profiling'], imagePrompt: "Overlapping blueprints of multiple corporate offices. A hidden, shared ventilation shaft is highlighted in glowing red. Technical, tense, and revealing." }
            ]
        },
    ],
    narrativeNodes: {
        '1_mo': { text: "Correct. The rage is a byproduct; the control is the goal. The doll is a surrogate. He doesn't just pose his victims, he replaces them. Each victim lived alone. He is filling a void, a twisted family album. His next target will be someone who reminds him of a lost family member.", timePenalty: 0, choices: [{ text: "Profile his next victim type: a mother figure.", next: '1_win', imagePrompt: "A shadowy figure watching a middle-aged woman through her window from across the street. Rain streaks down the glass, distorting the view. Voyeuristic, terrifying, cinematic." }] },
        '1_victimology': { text: "A dead end. The victims share no social or professional links. You're looking for a rational connection where there is only psychotic obsession. The UNSUB isn't choosing them for who they were, but for what they can become in his fantasy. Time bleeds away.", timePenalty: 90, isLoss: true, imagePrompt: "A wall covered in newspaper clippings of missing persons. A red string connects them randomly, nonsensically. A single bare bulb illuminates the obsessive madness. Gritty, disturbing." },
        '1_win': { text: "You've dissected his fantasy. You identify recently widowed women living alone as the highest-risk group. You set a trap at the residence of a potential target, and the Dollmaker walks right into it, carrying his box of tools. Case closed.", isWin: true, imagePrompt: "Cinematic shot of tactical police officers storming a suburban house at night. In the foreground, a man in shadows drops a porcelain doll, which shatters on the porch. High action, dramatic lighting." },
        '2_insight': { text: "The connection is buried deep. All victims were terminal patients, but their deaths were secretly self-requested through a dark web 'euthanasia' service. The UNSUB is a hospital employee who intercepted these requests, seeing himself as a merciful angel. He's not a purifier; he's a predator.", timePenalty: 0, choices: [{ text: "He works in a role with access to all floors.", next: '2_win', imagePrompt: "A hospital janitor's cart, seen from a low angle. In the reflection of a freshly mopped floor, the janitor's face is distorted into a monstrous grin. Horror movie aesthetic, unsettling." }] },
        '2_symbol': { text: "The feather is a red herring, a piece of theatricality. It speaks to his narcissism but doesn't identify him. You're chasing the symbol, not the man. A fatal delay.", timePenalty: 120, isLoss: true, imagePrompt: "A detective's gloved hand holding an evidence bag with the burnt feather. In the background, a body is being zipped into a body bag. The focus is on the wrong clue. Grim, procedural." },
        '2_win': { text: "Correct. His god complex requires access, but not specialized medical skill. You cross-reference hospital staff with access to the victims' rooms. Only one name fits: a night-shift orderly. You apprehend him during his rounds, a syringe of potassium chloride in his pocket. Case closed.", isWin: true, imagePrompt: "Point-of-view shot from a security camera. A hospital orderly is being arrested by plainclothes detectives in a quiet, sterile hallway. The scene is silent, swift, and brutal." },
        '3_geo': { text: "Your analysis reveals a ghost in the machine. All the targeted corporations use the same third-party data security firm. The UNSUB isn't an executive; he's an auditor, a wolf given the keys to the henhouse.", timePenalty: 0, choices: [{ text: "The bloody symbol must be on their corporate logo.", next: '3_fail', imagePrompt: "A side-by-side comparison. Left: The bloody spiral. Right: The clean, corporate logo of a security firm, which looks nothing like it. The connection is wrong. Tense, analytical." }]},
        '3_combo': { text: "Flawless synthesis. The victims all took part in a hostile takeover, orchestrated from a single, neutral-site law firm. Geographic profiling of their movements pinpoints this firm as the nexus. The UNSUB isn't targeting them for their success, but for a past sin.", timePenalty: 0, choices: [{ text: "The UNSUB was the CEO of the company they destroyed.", next: '3_win', imagePrompt: "A faded photograph from a business magazine of a smiling CEO shaking hands. The face is the same as your primary suspect. A moment of dawning horror and realization. Cinematic, dramatic."}]},
        '3_win': { text: "You've found the ghost. The former CEO of the company they dismantled, a man who lost everything. He's not a corporate player; he's a vengeful wraith. You find him in the archives of the law firm, about to eliminate the lawyer who structured the deal. Case closed.", isWin: true, imagePrompt: "A tense standoff in a dusty, paper-filled archive room. A disheveled man in a suit holds a weapon as detectives surround him. Dramatic shadows, film noir style." },
        '3_fail': { text: "You assumed a literal connection. The symbol is personal, not corporate. While you investigate the security firm, the real killer strikes again, targeting the lawyer who ruined him. The trail goes cold.", isLoss: true, imagePrompt: "An empty, luxurious law office at night. A briefcase lies open, papers scattered. Through the window, police lights flash far below, but the room is silent and cold. A scene of failure."}
    },
    abilities: [
        { id: "M.O. Analysis", desc: "Identify patterns in a criminal's methods.", unlocked: true },
        { id: "Victimology Insight", desc: "Uncover the psychological reasons behind victim selection.", unlocked: false },
        { id: "Geographic Profiling", desc: "Predict an unsub's operational base from crime locations.", unlocked: false },
    ]
};

const gameState = { level: 0, timer: 0, timerInterval: null, gameActive: false, playerAbilities: [] };

// DOM Elements
const timerEl = document.getElementById('timer');
const levelDisplayEl = document.getElementById('level-display');
const caseTitleEl = document.getElementById('case-title');
const narrativeTextEl = document.getElementById('narrative-text');
const choicesEl = document.getElementById('choices');
const modalEl = document.getElementById('modal');
const modalTitleEl = document.getElementById('modal-title');
const modalTextEl = document.getElementById('modal-text');
const modalContentEl = document.getElementById('modal-content');
const modalButtonsEl = document.getElementById('modal-buttons');
const visualOutputEl = document.getElementById('visual-output');

function init() {
    showModalForLevel(0);
}

function startLevel(levelIndex) {
    if (levelIndex >= gameData.levels.length) {
        winGame();
        return;
    }
    modalEl.classList.add('hidden');
    gameState.level = levelIndex;
    const level = gameData.levels[levelIndex];

    gameState.timer = level.timer;
    gameState.gameActive = true;
    levelDisplayEl.textContent = `LEVEL ${level.level}`;
    caseTitleEl.textContent = level.title;
    
    updateAbilities();
    
    setNarrative(level.narrative);
    generateAndDisplayImage(level.imagePrompt, () => {
        renderChoices(level.choices);
    });

    if (gameState.timerInterval) clearInterval(gameState.timerInterval);
    gameState.timerInterval = setInterval(updateTimer, 1000);
    updateTimer();
}

function updateTimer() {
    if(!gameState.gameActive) return;
    gameState.timer--;
    const minutes = Math.floor(gameState.timer / 60).toString().padStart(2, '0');
    const seconds = (gameState.timer % 60).toString().padStart(2, '0');
    timerEl.textContent = `${minutes}:${seconds}`;

    if (gameState.timer <= 0) {
        gameOver("Time expired. You've lost them.");
    }
    
    if (gameState.timer <= 60 && !timerEl.classList.contains('timer-critical')) {
        timerEl.classList.add('timer-critical');
    } else if (gameState.timer > 60) {
        timerEl.classList.remove('timer-critical');
    }
}

function setNarrative(text) {
    narrativeTextEl.innerHTML = '';
    typewriterEffect(narrativeTextEl, text);
}

function renderChoices(choices) {
    choicesEl.innerHTML = '';
    choices.forEach(choice => {
        const canChoose = checkRequirements(choice.requires);
        const button = document.createElement('button');
        button.className = "button w-full text-left p-3 rounded-lg text-sm";
        if (!canChoose) {
          button.classList.add('disabled');
        }
        button.disabled = !canChoose;
        button.innerHTML = choice.text;
        if (!canChoose) {
             button.innerHTML += `<span class="text-xs accent-red block">(Requires: ${choice.requires})</span>`;
        }
        button.onclick = () => handleChoice(choice);
        choicesEl.appendChild(button);
    });
}


function handleChoice(choice) {
    choicesEl.innerHTML = '<p class="text-gray-400">Analyzing...</p>';
    const nextNode = gameData.narrativeNodes[choice.next];

    if (nextNode.timePenalty > 0) {
        gameState.timer -= nextNode.timePenalty;
    }
    updateTimer();

    generateAndDisplayImage(nextNode.imagePrompt, () => {
        setNarrative(nextNode.text);
        if (nextNode.isWin) {
            levelComplete();
        } else if (nextNode.isLoss) {
            gameOver("Fatal error in judgement. Case closed, permanently.");
        } else {
            renderChoices(nextNode.choices);
        }
    });
}

async function generateAndDisplayImage(prompt, callback) {
    visualOutputEl.innerHTML = '<div class="loader"></div>';
    
    const apiKey = ""; // API key is handled by the environment
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
    const payload = { 
        instances: [{ "prompt": `award-winning cinematic photo, hyperrealistic, high-contrast, dramatic lighting, psychological thriller movie still, ${prompt}` }],
        parameters: { "sampleCount": 1 }
    };

    let response;
    try {
        response = await fetchWithBackoff(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`API request failed with status ${response.status}`);
        }

        const result = await response.json();
        if (result.predictions && result.predictions[0]?.bytesBase64Encoded) {
            const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
            visualOutputEl.innerHTML = `<img src="${imageUrl}" class="w-full h-full object-cover animate-fade-in">`;
        } else {
            throw new Error('Invalid image data in API response.');
        }
    } catch (error) {
        console.error('Image generation failed:', error);
        visualOutputEl.innerHTML = `<p class="text-red-500 p-4">VISUAL LINK CORRUPTED<br/>${error.message}</p>`;
    }
    
    if (callback) callback();
}

async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
    try {
        const response = await fetch(url, options);
        if (!response.ok && retries > 0 && response.status === 429) { // 429 Too Many Requests
            await new Promise(resolve => setTimeout(resolve, delay));
            return fetchWithBackoff(url, options, retries - 1, delay * 2);
        }
        return response;
    } catch (error) {
        if (retries > 0) {
            await new Promise(resolve => setTimeout(resolve, delay));
            return fetchWithBackoff(url, options, retries - 1, delay * 2);
        }
        throw error;
    }
}


function checkRequirements(requires) {
    if (!requires) return true;
    const reqs = Array.isArray(requires) ? requires : [requires];
    return reqs.every(req => gameState.playerAbilities.includes(req));
}

function levelComplete() {
    clearInterval(gameState.timerInterval);
    gameState.gameActive = false;
    
    modalTitleEl.textContent = "CASE CLOSED";
    modalContentEl.innerHTML = `<p class="text-2xl">You've stopped the killer.</p>`;
    modalButtonsEl.innerHTML = `
        <button id="psych-profile-btn" class="button text-xl font-bold py-3 px-8 rounded-lg mb-4 w-full">✨ Generate Psych Profile</button>
        <button id="next-case-btn" class="button text-xl font-bold py-3 px-8 rounded-lg w-full bg-gray-700 hover:bg-gray-600">Proceed to Next Case</button>
    `;
    
    document.getElementById('psych-profile-btn').onclick = generatePsychProfile;
    document.getElementById('next-case-btn').onclick = () => {
        gameState.level++;
        if (gameState.level >= gameData.levels.length) {
            winGame();
        } else {
            showModalForLevel(gameState.level);
        }
    };

    modalEl.classList.remove('hidden');
}

async function generatePsychProfile() {
    const level = gameData.levels[gameState.level];
    const psychButton = document.getElementById('psych-profile-btn');
    psychButton.disabled = true;
    psychButton.innerHTML = '<span class="loader-small inline-block"></span> Generating...';

    const systemPrompt = "You are a world-class criminal profiler working for the FBI's Behavioral Analysis Unit. Analyze the following case summary and produce a detailed, clinical, and insightful psychological profile of the Unidentified Subject (UNSUB). Focus on motivations, likely background, and post-offense behavior. The tone should be serious, academic, and chilling.";
    const userQuery = level.psychProfilePrompt;
    
    const apiKey = "";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: {
            parts: [{ text: systemPrompt }]
        },
    };

    try {
        const response = await fetchWithBackoff(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        
        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

        if (text) {
            modalTitleEl.textContent = `PSYCH PROFILE: ${level.title}`;
            modalContentEl.innerHTML = `<div class="text-left text-base overflow-y-auto max-h-96 pr-2">${text.replace(/\n/g, '<br>')}</div>`;
            psychButton.style.display = 'none'; // Hide the generate button
            document.getElementById('next-case-btn').textContent = "Continue";
        } else {
            throw new Error("No content returned from API.");
        }

    } catch (error) {
        console.error("Psych profile generation failed:", error);
        modalContentEl.innerHTML += `<p class="text-red-500 mt-4">Profile generation failed. Please try again.</p>`;
        psychButton.disabled = false;
        psychButton.innerHTML = '✨ Generate Psych Profile';
    }
}

function gameOver(message) {
    clearInterval(gameState.timerInterval);
    gameState.gameActive = false;
    modalTitleEl.textContent = "ANALYSIS TERMINATED";
    modalContentEl.innerHTML = `<p id="modal-text">${message}</p>`;
    modalButtonsEl.innerHTML = `<button id="modal-button" class="button text-2xl font-bold py-3 px-12 rounded-lg">RESTART</button>`;
    document.getElementById('modal-button').onclick = () => window.location.reload();
    modalEl.classList.remove('hidden');
}

function winGame() {
    modalTitleEl.textContent = "ABYSS STARES BACK";
    modalContentEl.innerHTML = `<p id="modal-text">You have stared into the abyss and unmasked the monsters within. But in doing so, the abyss has also seen you. The echoes will remain. For now, the city is quiet.</p>`;
    modalButtonsEl.innerHTML = `<button id="modal-button" class="button text-2xl font-bold py-3 px-12 rounded-lg">GO AGAIN</button>`;
    document.getElementById('modal-button').onclick = () => window.location.reload();
    modalEl.classList.remove('hidden');
}

function showModalForLevel(levelIndex) {
    const level = gameData.levels[levelIndex];
    modalTitleEl.innerHTML = `CASE FILE: ${level.title}`;
    modalContentEl.innerHTML = `<p id="modal-text">${level.briefing}</p>`;
    modalButtonsEl.innerHTML = `<button id="modal-button" class="button text-2xl font-bold py-3 px-12 rounded-lg">BEGIN ANALYSIS</button>`;
    document.getElementById('modal-button').onclick = () => startLevel(levelIndex);
    modalEl.classList.remove('hidden');
}

function updateAbilities() {
    gameState.playerAbilities = gameData.abilities.filter((_, i) => i <= gameState.level).map(a => a.id);
}

function typewriterEffect(element, text, i = 0) {
    if (i === 0) element.innerHTML = '';
    if (i < text.length) {
        element.innerHTML += text.charAt(i);
        setTimeout(() => typewriterEffect(element, text, i + 1), 20);
    }
}

init();
</script>
</body>
</html>